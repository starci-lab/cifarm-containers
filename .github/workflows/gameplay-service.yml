name: CI/CD Pipeline for Gameplay Service

on:
  push:
    branches:
      - build
    paths:
      - 'src/**'  # Trigger the workflow when files under the 'src' folder change
      - 'apps/gameplay-service/**'  # Trigger the workflow when files under the 'apps/gameplay-service' folder change
jobs:
  deployment:
    concurrency:
      group: "gameplay-service-deployment"
      cancel-in-progress: true
    runs-on: self-hosted
    environment: cifarm
    steps:
    - name: Checkout code
      uses: actions/checkout@v2 
    
    - name: Create manifest.yaml file
      run: |
        if ! helm repo list | grep -q "cifarm"; then
          helm repo add cifarm https://starci-lab.github.io/cifarm-k8s/charts
        else
          helm repo update cifarm
        fi
        helm template gameplay-service cifarm/gameplay-service-build > \
          ./manifest.yaml

    - name: Create namespace
      run: kubectl create namespace gameplay-service \
           2>/dev/null || echo "Namespace 'gameplay-service' already exist"

    - name: Apply Kaniko Build
      run: |
        if kubectl get pod gameplay-service-kaniko-build; then
          kubectl delete pod gameplay-service-kaniko-build
        fi
        kubectl apply -f ./manifest.yaml
  
    - name: Wait for Kaniko Build to Complete
      run: |
        kubectl wait pod/gameplay-service-kaniko-build \
        --for jsonpath="status.containerStatuses[0].state.terminated.reason"=Completed \
        --namespace build \
        --timeout=20m
      continue-on-error: false
    - name: Create secret
      run: |
        kubectl delete secret generic gameplay-service-env \
        --namespace gameplay-service \
        --ignore-not-found
        kubectl create secret generic gameplay-service-env --namespace gameplay-service \
        --from-literal=GAMEPLAY_POSTGRES_DBNAME=${{ vars.GAMEPLAY_POSTGRES_DBNAME }} \
        --from-literal=GAMEPLAY_POSTGRES_HOST=${{ vars.GAMEPLAY_POSTGRES_HOST }} \
        --from-literal=GAMEPLAY_POSTGRES_PORT=${{ vars.GAMEPLAY_POSTGRES_PORT }} \
        --from-literal=GAMEPLAY_POSTGRES_USER=${{ secrets.GAMEPLAY_POSTGRES_USER }} \
        --from-literal=GAMEPLAY_POSTGRES_PASS=${{ secrets.GAMEPLAY_POSTGRES_PASS }} \
        --from-literal=GAMEPLAY_POSTGRES_SSL=${{ vars.CACHE_REDIS_HOST }} \
        --from-literal=GAMEPLAY_POSTGRES_SSL=${{ vars.CACHE_REDIS_PORT }}

    - name: Apply the Deployment
      run: kubectl apply -f ./manifest.yaml -l mode=deploy